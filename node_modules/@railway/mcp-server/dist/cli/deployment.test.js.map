{"version":3,"file":"deployment.test.js","names":["mockProject: RailwayProject","core.runRailwayCommand","core.checkRailwayCliStatus","projects.getLinkedProjectInfo","version.getCliFeatureSupport","version.getRailwayVersion"],"sources":["../../src/cli/deployment.test.ts"],"sourcesContent":["import { afterEach, beforeEach, describe, expect, it, vi } from \"vitest\";\nimport * as core from \"./core\";\nimport { listDeployments } from \"./deployment\";\nimport * as errorHandling from \"./error-handling\";\nimport type { RailwayProject } from \"./projects\";\nimport * as projects from \"./projects\";\nimport * as version from \"./version\";\n\n// Mock the dependencies\nvi.mock(\"./core\");\nvi.mock(\"./error-handling\");\nvi.mock(\"./projects\");\nvi.mock(\"./version\");\n\ndescribe(\"listDeployments\", () => {\n  const mockWorkspacePath = \"/test/workspace\";\n\n  const mockProject: RailwayProject = {\n    id: \"test-project-id\",\n    name: \"test-project\",\n    createdAt: \"2024-01-01T00:00:00Z\",\n    updatedAt: \"2024-01-01T00:00:00Z\",\n  };\n\n  beforeEach(() => {\n    vi.clearAllMocks();\n\n    const mockOutput = \"Deployment 1\\nDeployment 2\\nDeployment 3\";\n    vi.mocked(core.runRailwayCommand).mockResolvedValue({\n      output: mockOutput,\n      stderr: \"\",\n      stdout: mockOutput,\n    });\n    vi.mocked(core.checkRailwayCliStatus).mockResolvedValue();\n    vi.mocked(projects.getLinkedProjectInfo).mockResolvedValue({\n      success: true,\n      project: mockProject,\n    });\n    vi.mocked(version.getCliFeatureSupport).mockResolvedValue({\n      logs: {\n        args: {\n          lines: true,\n          filter: true,\n        },\n      },\n      deployment: {\n        list: true,\n      },\n    });\n    vi.mocked(version.getRailwayVersion).mockResolvedValue(\"4.10.0\");\n  });\n\n  afterEach(() => {\n    vi.restoreAllMocks();\n  });\n\n  describe(\"successful cases\", () => {\n    it(\"should list deployments with default options\", async () => {\n      const result = await listDeployments({\n        workspacePath: mockWorkspacePath,\n      });\n\n      expect(result.success).toBe(true);\n      expect(core.runRailwayCommand).toHaveBeenCalledWith(\n        \"railway deployment list --limit 20\",\n        mockWorkspacePath\n      );\n    });\n\n    it(\"should list deployments with JSON output\", async () => {\n      const result = await listDeployments({\n        workspacePath: mockWorkspacePath,\n        json: true,\n      });\n\n      expect(result.success).toBe(true);\n      expect(core.runRailwayCommand).toHaveBeenCalledWith(\n        \"railway deployment list --limit 20 --json\",\n        mockWorkspacePath\n      );\n    });\n\n    it(\"should list deployments with service filter\", async () => {\n      const result = await listDeployments({\n        workspacePath: mockWorkspacePath,\n        service: \"my-api-service\",\n      });\n\n      expect(result.success).toBe(true);\n      expect(core.runRailwayCommand).toHaveBeenCalledWith(\n        \"railway deployment list --service my-api-service --limit 20\",\n        mockWorkspacePath\n      );\n    });\n\n    it(\"should list deployments with environment filter\", async () => {\n      const mockOutput = \"Environment deployment output\";\n      vi.mocked(core.runRailwayCommand).mockResolvedValue({\n        output: mockOutput,\n        stderr: \"\",\n        stdout: mockOutput,\n      });\n\n      const result = await listDeployments({\n        workspacePath: mockWorkspacePath,\n        environment: \"staging\",\n      });\n\n      expect(result.success).toBe(true);\n      expect(core.runRailwayCommand).toHaveBeenCalledWith(\n        \"railway deployment list --environment staging --limit 20\",\n        mockWorkspacePath\n      );\n    });\n\n    it(\"should list deployments with custom limit\", async () => {\n      const mockOutput = \"Limited deployment output\";\n      vi.mocked(core.runRailwayCommand).mockResolvedValue({\n        output: mockOutput,\n        stderr: \"\",\n        stdout: mockOutput,\n      });\n\n      const result = await listDeployments({\n        workspacePath: mockWorkspacePath,\n        limit: 50,\n      });\n\n      expect(result.success).toBe(true);\n      expect(core.runRailwayCommand).toHaveBeenCalledWith(\n        \"railway deployment list --limit 50\",\n        mockWorkspacePath\n      );\n    });\n  });\n\n  it(\"should return error when CLI version does not support deployment list\", async () => {\n    vi.mocked(version.getCliFeatureSupport).mockResolvedValue({\n      logs: {\n        args: {\n          lines: false,\n          filter: false,\n        },\n      },\n      deployment: {\n        list: false,\n      },\n    });\n    vi.mocked(version.getRailwayVersion).mockResolvedValue(\"4.9.0\");\n\n    const result = await listDeployments({\n      workspacePath: mockWorkspacePath,\n    });\n\n    expect(result.success).toBe(false);\n    if (result.success) {\n      throw new Error(\"Expected error\");\n    }\n    expect(result.error).toBe(\n      \"Railway CLI version 4.9.0 does not support 'deployment list' command. Please upgrade to version 4.10.0 or later.\"\n    );\n  });\n});\n"],"mappings":"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"}