{"version":3,"file":"deploy-template-CE3DJG5u.js","names":["error: unknown"],"sources":["../src/api/deploy-template.ts"],"sourcesContent":["import Fuse from \"fuse.js\";\nimport { GraphQLClient } from \"graphql-request\";\nimport { getRailwayAuthToken } from \"./auth\";\n\nexport type ServiceConfig = {\n\t[key: string]: unknown;\n};\n\nexport type SerializedTemplateConfig = {\n\tservices: Record<string, ServiceConfig>;\n};\n\nexport type TemplateDeployResponse = {\n\tprojectId: string;\n\tworkflowId: string;\n};\n\nexport type Template = {\n\tid: string;\n\tname: string;\n\tdescription: string;\n\tcategory: string;\n\tserializedConfig: SerializedTemplateConfig;\n\tactiveProjects: number;\n\thealth: number;\n\ttotalPayout: number;\n\tisVerified: boolean;\n};\n\nexport const searchAndListTemplates = async ({\n\tsearchQuery,\n}: {\n\tsearchQuery?: string;\n}): Promise<{\n\ttemplates: Template[];\n\tfilteredCount: number;\n\ttotalCount: number;\n}> => {\n\tconst query = `\n\t\tquery {\n\t\t\ttemplates {\n\t\t\t\tedges {\n\t\t\t\t\tnode {\n\t\t\t\t\t\tid\n\t\t\t\t\t\tname\n\t\t\t\t\t\tdescription\n\t\t\t\t\t\tcategory\n\t\t\t\t\t\tserializedConfig\n\t\t\t\t\t\tactiveProjects\n\t\t\t\t\t\thealth\n\t\t\t\t\t\ttotalPayout\n\t\t\t\t\t\tisVerified\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t`;\n\n\ttry {\n\t\tconst client = new GraphQLClient(\n\t\t\t\"https://backboard.railway.com/graphql/v2\",\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\t\"x-source\": \"railway-mcp-server\",\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tconst data = await client.request<{\n\t\t\ttemplates: {\n\t\t\t\tedges: Array<{\n\t\t\t\t\tnode: Template;\n\t\t\t\t}>;\n\t\t\t};\n\t\t}>(query);\n\n\t\tconst templates = data.templates.edges.map(\n\t\t\t(edge) => edge.node,\n\t\t) as Template[];\n\t\tconst totalCount = templates.length;\n\n\t\t// Sort templates based on the specified criteria (verified templates first, then by totalPayout, then by activeProjects, then by health)\n\t\tconst sortedTemplates = templates.sort((a: Template, b: Template) => {\n\t\t\tif (a.isVerified && !b.isVerified) return -1;\n\t\t\tif (!a.isVerified && b.isVerified) return 1;\n\n\t\t\tif (a.totalPayout !== b.totalPayout) {\n\t\t\t\treturn (b.totalPayout || 0) - (a.totalPayout || 0);\n\t\t\t}\n\n\t\t\tif (a.activeProjects !== b.activeProjects) {\n\t\t\t\treturn (b.activeProjects || 0) - (a.activeProjects || 0);\n\t\t\t}\n\n\t\t\tif (a.health !== b.health) {\n\t\t\t\treturn (b.health || 0) - (a.health || 0);\n\t\t\t}\n\n\t\t\t// If all criteria are equal, maintain original order\n\t\t\treturn 0;\n\t\t});\n\n\t\t// If no search query provided, return all sorted templates\n\t\tif (!searchQuery || searchQuery.trim() === \"\") {\n\t\t\treturn {\n\t\t\t\ttemplates: sortedTemplates,\n\t\t\t\tfilteredCount: totalCount,\n\t\t\t\ttotalCount,\n\t\t\t};\n\t\t}\n\n\t\t// Configure Fuse.js for fuzzy search\n\t\tconst fuse = new Fuse(sortedTemplates, {\n\t\t\tkeys: [\"name\", \"description\", \"category\"],\n\t\t\tthreshold: 0.3, // Lower threshold = more strict matching\n\t\t\tincludeScore: true,\n\t\t\tincludeMatches: true,\n\t\t});\n\n\t\t// Perform fuzzy search\n\t\tconst searchResults = fuse.search(searchQuery.trim());\n\t\tconst filteredTemplates = searchResults.map((result) => result.item);\n\n\t\treturn {\n\t\t\ttemplates: filteredTemplates,\n\t\t\tfilteredCount: filteredTemplates.length,\n\t\t\ttotalCount,\n\t\t};\n\t} catch (error: unknown) {\n\t\tif (error instanceof Error) {\n\t\t\tthrow new Error(`Failed to search Railway templates: ${error.message}`);\n\t\t}\n\t\tthrow new Error(\"Failed to search Railway templates: Unknown error\");\n\t}\n};\n\nexport const deployTemplate = async ({\n\tenvironmentId,\n\tprojectId,\n\tserializedConfig,\n\ttemplateId,\n\tteamId,\n}: {\n\tenvironmentId: string;\n\tprojectId: string;\n\tserializedConfig: SerializedTemplateConfig;\n\ttemplateId: string;\n\tteamId?: string;\n}): Promise<TemplateDeployResponse> => {\n\tconst query = `\n\t\tmutation deployTemplate($environmentId: String, $projectId: String, $templateId: String!, $teamId: String, $serializedConfig: SerializedTemplateConfig!) {\n\t\t\ttemplateDeployV2(input: {\n\t\t\t\tenvironmentId: $environmentId,\n\t\t\t\tprojectId: $projectId,\n\t\t\t\ttemplateId: $templateId,\n\t\t\t\tteamId: $teamId,\n\t\t\t\tserializedConfig: $serializedConfig\n\t\t\t}) {\n\t\t\t\tprojectId\n\t\t\t\tworkflowId\n\t\t\t}\n\t\t}\n\t`;\n\n\ttry {\n\t\tconst token = getRailwayAuthToken();\n\t\tconst client = new GraphQLClient(\n\t\t\t\"https://backboard.railway.com/graphql/v2\",\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${token}`,\n\t\t\t\t\t\"x-source\": \"railway-mcp-server\",\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tconst data = await client.request<{\n\t\t\ttemplateDeployV2: TemplateDeployResponse;\n\t\t}>(query, {\n\t\t\tenvironmentId,\n\t\t\tprojectId,\n\t\t\ttemplateId,\n\t\t\tteamId,\n\t\t\tserializedConfig,\n\t\t});\n\n\t\treturn data.templateDeployV2;\n\t} catch (error: unknown) {\n\t\tif (error instanceof Error) {\n\t\t\tthrow new Error(`Failed to deploy template: ${error.message}`);\n\t\t}\n\t\tthrow new Error(\"Failed to deploy template: Unknown error\");\n\t}\n};\n"],"mappings":";;;;;AA6BA,MAAa,yBAAyB,OAAO,EAC5C,kBAOK;CACL,MAAM,QAAQ;;;;;;;;;;;;;;;;;;;AAoBd,KAAI;EAkBH,MAAM,aARO,MATE,IAAI,cAClB,4CACA,EACC,SAAS,EACR,YAAY,sBACZ,EACD,CACD,CAEyB,QAMvB,MAAM,EAEc,UAAU,MAAM,KACrC,SAAS,KAAK,KACf;EACD,MAAM,aAAa,UAAU;EAG7B,MAAM,kBAAkB,UAAU,MAAM,GAAa,MAAgB;AACpE,OAAI,EAAE,cAAc,CAAC,EAAE,WAAY,QAAO;AAC1C,OAAI,CAAC,EAAE,cAAc,EAAE,WAAY,QAAO;AAE1C,OAAI,EAAE,gBAAgB,EAAE,YACvB,SAAQ,EAAE,eAAe,MAAM,EAAE,eAAe;AAGjD,OAAI,EAAE,mBAAmB,EAAE,eAC1B,SAAQ,EAAE,kBAAkB,MAAM,EAAE,kBAAkB;AAGvD,OAAI,EAAE,WAAW,EAAE,OAClB,SAAQ,EAAE,UAAU,MAAM,EAAE,UAAU;AAIvC,UAAO;IACN;AAGF,MAAI,CAAC,eAAe,YAAY,MAAM,KAAK,GAC1C,QAAO;GACN,WAAW;GACX,eAAe;GACf;GACA;EAaF,MAAM,oBATO,IAAI,KAAK,iBAAiB;GACtC,MAAM;IAAC;IAAQ;IAAe;IAAW;GACzC,WAAW;GACX,cAAc;GACd,gBAAgB;GAChB,CAAC,CAGyB,OAAO,YAAY,MAAM,CAAC,CACb,KAAK,WAAW,OAAO,KAAK;AAEpE,SAAO;GACN,WAAW;GACX,eAAe,kBAAkB;GACjC;GACA;UACOA,OAAgB;AACxB,MAAI,iBAAiB,MACpB,OAAM,IAAI,MAAM,uCAAuC,MAAM,UAAU;AAExE,QAAM,IAAI,MAAM,oDAAoD;;;AAItE,MAAa,iBAAiB,OAAO,EACpC,eACA,WACA,kBACA,YACA,aAOsC;CACtC,MAAM,QAAQ;;;;;;;;;;;;;;AAed,KAAI;EACH,MAAM,QAAQ,qBAAqB;AAqBnC,UAVa,MAVE,IAAI,cAClB,4CACA,EACC,SAAS;GACR,eAAe,UAAU;GACzB,YAAY;GACZ,EACD,CACD,CAEyB,QAEvB,OAAO;GACT;GACA;GACA;GACA;GACA;GACA,CAAC,EAEU;UACJA,OAAgB;AACxB,MAAI,iBAAiB,MACpB,OAAM,IAAI,MAAM,8BAA8B,MAAM,UAAU;AAE/D,QAAM,IAAI,MAAM,2CAA2C"}