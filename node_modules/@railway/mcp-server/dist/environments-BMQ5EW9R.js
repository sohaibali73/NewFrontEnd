import { analyzeRailwayError } from "./error-handling-mxVa5oOu.js";
import { checkRailwayCliStatus, runRailwayCommand, runRailwayJsonCommand } from "./core-BMlc7cvF.js";
import { getLinkedProjectInfo } from "./projects-ENU6yIz7.js";

//#region src/cli/environments.ts
const getCurrentEnvironmentId = async ({ workspacePath }) => {
	try {
		await checkRailwayCliStatus();
		const result = await getLinkedProjectInfo({ workspacePath });
		if (!result.success) throw new Error(result.error);
		const { output: statusOutput } = await runRailwayCommand("railway status", workspacePath);
		const envNameMatch = statusOutput.match(/Environment:\s+(\w+)/);
		if (!envNameMatch?.[1]) throw new Error("Could not determine current environment name");
		const currentEnvironmentName = envNameMatch[1];
		const statusData = await runRailwayJsonCommand("railway status --json", workspacePath);
		if (statusData.environments?.edges?.length > 0) for (const envEdge of statusData.environments.edges) {
			const env = envEdge.node;
			if (env.name === currentEnvironmentName) return env.id;
		}
		throw new Error(`Could not determine environment ID for environment: ${currentEnvironmentName}`);
	} catch (error) {
		return analyzeRailwayError(error, "railway environment");
	}
};
const linkRailwayEnvironment = async ({ workspacePath, environmentName }) => {
	try {
		await checkRailwayCliStatus();
		const result = await getLinkedProjectInfo({ workspacePath });
		if (!result.success) throw new Error(result.error);
		const command = environmentName ? `railway environment ${environmentName}` : "railway environment";
		const { output } = await runRailwayCommand(command, workspacePath);
		return output;
	} catch (error) {
		return analyzeRailwayError(error, "railway environment");
	}
};
const createRailwayEnvironment = async ({ workspacePath, environmentName, duplicateEnvironment, serviceVariables }) => {
	try {
		await checkRailwayCliStatus();
		const result = await getLinkedProjectInfo({ workspacePath });
		if (!result.success) throw new Error(result.error);
		let command = `railway environment new ${environmentName}`;
		if (duplicateEnvironment) command += ` --duplicate ${duplicateEnvironment}`;
		if (serviceVariables && serviceVariables.length > 0) for (const sv of serviceVariables) command += ` --service-variable ${sv.service} ${sv.variable}`;
		const { output } = await runRailwayCommand(command, workspacePath);
		return output;
	} catch (error) {
		return analyzeRailwayError(error, `railway environment new ${environmentName}`);
	}
};

//#endregion
export { createRailwayEnvironment, getCurrentEnvironmentId, linkRailwayEnvironment };
//# sourceMappingURL=environments-BMQ5EW9R.js.map